<div ng-controller="modelCompositionCtrl">

  <style>

    #slice {
      color: #ebcccc;
    }

    #section {
      background-color: #00ff26;
    }

  </style>

  <div ng-show="selectedComposition">

  <div class="modelInfo row">
    <div class="col-md-7">

        <strong>{{selectedComposition.title}} </strong> ({{selectedComposition.name}})
        <div><em>{{selectedComposition.description}}</em></div>
        <div>
          <div ng-show="selectedComposition.sourceReference">
            <strong>Source reference</strong>: {{selectedComposition.sourceReference}}
          </div>
        </div>
        <br/>
        <div>
          <button class="btn btn-link"
                  ng-hide = "selectedComposition.checkedOut == user.email"
                  ng-click="deleteComposition(selectedComposition)">Remove from local store.</button>
        </div>
    </div>
    <div class="col-md-5">


      <div class="pull-right">
        <div ng-show="user.email">

          <button class="btn btn-success"
                  ng-hide="selectedComposition.checkedOut" class="clickable" ng-click="checkOut()">Check out</button>

          <button class="btn btn-danger"
                  ng-show="selectedComposition.checkedOut && selectedComposition.checkedOut == user.email"
                  ng-click="revert()">Revert</button>

          <button class="btn btn-warning"
                  ng-show="selectedComposition.checkedOut && selectedComposition.checkedOut == user.email"
                  ng-click="checkIn()">Check in</button>

          <div ng-show = "selectedComposition.checkedOut && selectedComposition.checkedOut !== user.email">
            <strong>Checked out to {{selectedComposition.checkedOut}}</strong>
          </div>
        </div>
      </div>



      <table class="table-condensed table table-bordered">
        <tr><td>Tumour stream</td><td>{{selectedComposition.meta.tumourStream}}</td></tr>
        <tr><td>Category</td><td>{{selectedComposition.meta.category}}</td></tr>

        <tr><td></td><td><em>Set these in the Metadata tab</em></td></tr>
      </table>
    </div>


  </div>

  <div class = "clickable pull-right">

    <button class="btn-link btn pull-right" ng-click="libraryInteraction(selectedComposition)">Compare to library</button>
  </div>

  <uib-tabset active="input.compTabActive" >

    <uib-tab heading="Tree">

      <div class="row">
        <div class="col-md-5">
          <em style="padding-top: 8px" class="pull-right clickable" ng-click="expandCompTree()">Expand all</em>
          <br/>
          <div class="myScroll">
            <div id="compositionTree"></div>

            <br/>
            <div><em>Legend:</em></div>
            <div><strong style="margin-left: 8px">Bold</strong> elements are required</div>
            <div><span style="color: blue; margin-left: 8px">Blue</span>  elements have a fixed value</div>
            <div style=" margin-left: 8px">A trailing <strong>*</strong> indicates multiples are supported.</div>

            <div style=" margin-left: 8px"><span style="text-decoration: line-through">Strike-through</span> indicates the element does not appear in a Q</div>
            <div style=" margin-left: 8px">
            <span style="text-decoration-line: underline;text-decoration-style: dotted">
              Dotted underline</span> indicates the element is subject to conditional show in the Q</div>




          </div>

        </div>


        <div class="col-md-7">

          <uib-tabset>
            <uib-tab heading = "Details">
              <div ng-show="selectedCompositionNode">

              <div class="row">
                <div class="col-md-3">
                  Path
                </div>
                <div class="col-md-9">
                  {{selectedCompositionNode.data.ed.path}}
                </div>
              </div>

                <div class="row">
                  <div class="col-md-3">
                    Appears in Q
                  </div>
                  <div class="col-md-9">
                    <div ng-show = "selectedCompositionNode.data.ed.hideInQ">
                      No
                    </div>
                    <div ng-hide = "selectedCompositionNode.data.ed.hideInQ">
                      Yes
                    </div>
                  </div>
                </div>

              <div class="row" ng-show="selectedCompositionNode.data.ed.parent">
                <div class="col-md-3">
                  Parent
                </div>
                <div class="col-md-9">
                  {{selectedCompositionNode.data.ed.parent}}
                </div>
              </div>


                <div class="row">
                  <div class="col-md-3">
                    Kind
                  </div>
                  <div class="col-md-9">
                    {{selectedCompositionNode.data.ed.kind}}
                  </div>
                </div>

                <div class="row" ng-hide = "selectedCompositionNode.data.ed.kind == 'section' || selectedCompositionNode.data.ed.kind == 'root'">
                  <div class="col-md-3">
                    Type
                  </div>
                  <div class="col-md-9">
                    <div class="clickable" ng-click="termSelectDG({DGName:selectedCompositionNode.data.ed.name})  ">
                      {{selectedCompositionNode.data.ed.name}}
                    </div>
                  </div>
                </div>

                <div class="row" >
                  <div class="col-md-3">
                    Title
                  </div>
                  <div class="col-md-9">
                    {{selectedCompositionNode.data.ed.title}}
                  </div>
                </div>

              <div ng-hide = "selectedCompositionNode.data.ed.kind == 'section' || selectedCompositionNode.data.ed.kind == 'root'">

                <div class="row">
                  <div class="col-md-3">
                    Description
                  </div>
                  <div class="col-md-9">
                    {{selectedCompositionNode.data.ed.description}}
                  </div>
                </div>

                <div class="row"  ng-show = "selectedCompositionNode.data.ed.kind == 'element'">
                  <div class="col-md-3">
                    Type
                  </div>
                  <div class="col-md-9">
                    <div ng-repeat="type in selectedCompositionNode.data.ed.type">
                      <div ng-show="fhirDataTypes.indexOf(type) > -1" class="pull-right">
                        <a target = "_blank" ng-href="{{fhirRoot}}datatypes.html#{{type}}">Details in spec</a>
                      </div>
                      {{type}}
                    </div>

                  </div>
                </div>

                <div class="row"  ng-show="selectedCompositionNode.data.ed.type[0] == 'CodeableConcept'">
                  <div class="col-md-3">
                    ValueSet
                  </div>
                  <div class="col-md-9">
                    <div><em>{{selectedCompositionNode.data.ed.valueSet}}</em></div>
                    <div>
                      <button ng-show="selectedCompositionNode.data.ed.valueSet"
                            ng-click="viewVS(selectedCompositionNode.data.ed.valueSet)"
                            class="btn-link btn">View VS</button>
<!--
                      <button ng-show="selectedCompositionNode.data.ed.valueSet"
                              ng-click = "changeValueSet(selectedCompositionNode.data.ed)"
                              class="btn-link btn">Change VS</button>


                      <button ng-hide="selectedCompositionNode.data.ed.valueSet"
                              ng-click = "changeValueSet(selectedCompositionNode.data.ed)"
                              class="btn-link btn">Set VS</button>
                      -->

                    </div>
                  </div>
                </div>



                <div class="row"  ng-show = "selectedCompositionNode.data.ed.kind == 'element'">
                  <div class="col-md-3">
                    Fixed value
                  </div>
                  <div class="col-md-9">
                    {{selectedCompositionNode.data.ed.fixedCoding}}
                    {{selectedCompositionNode.data.ed.fixedString}}
                    {{selectedCompositionNode.data.ed.fixedDecimal}}
                  </div>
                </div>


                <div class="row"  ng-show="selectedCompositionNode.data.ed.type[0] == 'CodeableConcept'">
                  <div class="col-md-3">
                    Options List
                  </div>
                  <div class="col-md-9">
                    <div ng-show="selectedCompositionNode.data.ed.options">
                      There are {{selectedCompositionNode.data.ed.options.length}} options defined
                    </div>

                    <div ng-hide="selectedCompositionNode.data.ed.options">
                      There are no options defined
                    </div>



                      <button
                              ng-click = "editOptionsList(selectedCompositionNode.data.ed)"
                              class="btn-link btn">View / Edit list</button>

                  </div>
                </div>

                <div class="row">
                  <div class="col-md-3">
                    Cardinality
                  </div>
                  <div class="col-md-9">
                    <!-- If this is a section, then the cardinality is in the sectionItem element. Otherwise, the ed-->

                    <div ng-show = "selectedCompositionNode.data.host">{{selectedCompositionNode.data.host.mult}}</div>
                    <div ng-hide = "selectedCompositionNode.data.host">{{selectedCompositionNode.data.ed.mult}}</div>

                  </div>
                </div>

                <div class="row">
                  <div class="col-md-3">
                    Conditional show
                  </div>



                  <div class="col-md-9">

                    <div ng-repeat="ew in selectedCompositionNode.data.ed.enableWhen">
                      Shown when {{ew.source}} = {{ew.value}}
                    </div>

                  </div>
                </div>


                <div class="row" ng-show = "selectedCompositionNode.data.ed.kind == 'element'">
                  <div class="col-md-3">
                    Control Type
                  </div>
                  <div class="col-md-9">
                    {{selectedCompositionNode.data.ed.controlType}}
                  </div>
                </div>

                <div class="row" ng-show = "selectedCompositionNode.data.ed.kind == 'element'">
                  <div class="col-md-3">
                    Control Hint
                  </div>
                  <div class="col-md-9">
                    {{selectedCompositionNode.data.ed.controlHint}}
                  </div>
                </div>

                <div class="row" ng-show = "selectedCompositionNode.data.ed.kind == 'element'">
                  <div class="col-md-3">
                    Notes
                  </div>
                  <div class="col-md-9">
                    {{selectedCompositionNode.data.ed.notes}}
                  </div>
                </div>

                <!--
               <div class="row" ng-show="selectedCompositionNode.data.ed.slice">
                 <div class="col-md-3">
                   Slice Info
                 </div>
                 <div class="col-md-9">
                   {{selectedCompositionNode.data.ed.slice.name}}
                 </div>
                </div>
                -->

              </div>

              <div class="row" ng-show = "selectedCompositionNode.data.ed.zElement">
                <div class="col-md-3">

                </div>
                <div class="col-md-9">
                  <em>This element has been added directly (a 'Z' element)</em>
                  
                </div>
              </div>


                <div ng-show = "canEditComp(selectedComposition)">

            <!-- If the root is selected, we can add a new section-->
            <div ng-show="selectedCompositionNode.id.indexOf('.') == -1">
              <br/>
              <strong>Add section</strong>
              <div class="row">
                <div class="col-md-4">
                  <input type="text" placeholder="Title" class="form-control" ng-model="input.newSectionTitle"/>



                </div>
                <div class="col-md-4">
                  <button class="btn-link btn"
                          ng-show="input.newSectionTitle"
                          ng-click="addSection(selectedComposition,input.newSectionTitle)">Add new section</button>
                </div>
              </div>
            </div>





            <div ng-hide ="selectedCompositionNode.data.ed.mult == '0..0'  ||
              selectedCompositionNode.data.ed.zElement || selectedCompositionNode.data.ed.kind == 'root'">

              <button class="btn-link btn pull-right"
                ng-hide = "selectedCompositionNode.data.ed.kind == 'section'"
                      ng-click="removeElement(selectedCompositionNode.data.ed)">Remove this element</button>

              <button class="btn-link btn pull-right"
                      ng-show = "selectedCompositionNode.data.ed.kind == 'element'"
                      ng-click="editOverride(selectedCompositionNode.data.ed)">Edit </button>

            </div>

            <div ng-show="selectedCompositionNode.data.ed.zElement">
              <button ng-click="removeZElement(selectedCompositionNode.data.ed)" class="btn btn-link pull-right">Remove this element</button>
            </div>

              <div ng-show ="selectedCompositionNode.data.ed.kind == 'dg' || selectedCompositionNode.data.ed.kind == 'section'">
                <button class="btn-link btn pull-right"
                        ng-click="addZElement(selectedCompositionNode.data.ed)">Add Z element</button>
              </div>


               <div ng-show="selectedCompositionNode.data.ed.kind == 'section'">
                 <br/><br/>
                 <strong>Add new DG to section</strong>

               <div class="row">
                 <div class="col-md-4">


                   <div class="clickable" ng-click="selectDGForSection()">Select DG</div>
                   <div>Type: {{input.newCompType.name}}</div>

                   <br/>

                   <div>
                     <input placeholder ="path (no spaces)" type="text" class="form-control"
                            ng-model="input.newCompName"/>
                   </div>

                   <div>
                     <input placeholder ="Title (in tree)" type="text" class="form-control"
                            ng-model="input.newCompTitle"/>
                   </div>
                   <button ng-show = "input.newCompType" class="btn btn-link"
                           ng-click="addDGtoSection(
                            selectedCompositionNode.data.ed,
                             input.newCompType,
                             input.newCompName,
                             input.newCompTitle)">Add DG</button>


                 </div>

                 <div class="col-md-8">
                   <table class="table-bordered table">
                     <tr ng-repeat="ed in input.newCompType.diff">
                       <td>{{ed.title}}</td>
                       <td>{{ed.type[0]}}</td>
                       <td>{{ed.mult}}</td>
                       <td>{{ed.description}}</td>
                     </tr>
                   </table>

                 </div>
               </div>
            </div>

            </div>

              </div>

            </uib-tab>




            <uib-tab heading = "Json">
              <pre>{{selectedCompositionNode.data | json}}</pre>
            </uib-tab>

          </uib-tabset>

        </div>
      </div>


    </uib-tab>


    <uib-tab heading="Table">

      <div class="row">
        <em>This will become the HISO download</em>

        <a class="btn btn-link pull-right" download="{{downloadLinkCompTsvName}}"
           href="{{downloadLinkCompTsv}}" title="{{downloadLinkCompTsvName}}" >
          Download
        </a>


      </div>

      <div class="tableFixHead">
        <table class="table table-bordered">
          <thead>
          <tr><th>Path</th><th>Title</th><th>Kind</th><th>Description</th><th>Type</th><th>Card.</th></tr>
          </thead>
          <tbody>
          <tr
                  ng-style="{ 'background-color': getRowColour(item.ed) }"
                  ng-repeat="item in allCompElements track by $index">
            <td>
              <div ng-style="{ 'padding-left': (item.ed.path | pathindent) }">
                {{item.ed.path | lastInPath}}
              </div>

            </td>
            <td>{{item.ed.title}}</td>
            <td>{{item.ed.kind}}</td>
            <td>{{item.ed.description}}</td>
            <td>{{item.ed.type[0]}}</td>

            <td>


              <!-- If this is a section, then the cardinality is in the sectionItem element. Otherwise, the ed-->

              <div ng-show = "item.host">{{item.host.mult}}</div>
              <div ng-hide = "item.host">{{item.ed.mult}}</div>

            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </uib-tab>


    <uib-tab heading = "Sections">
      <br/>
      <div ng-controller="compSectionsCtrl">
        <ng-include src ="'includes/compSections.html'"></ng-include>

      </div>
    </uib-tab>


    <uib-tab heading="Conditionals">
      <br/>
      <div ng-show="selectedComposition.enableWhen.length > 0">
        <strong>Section level Conditionals present in the Composition</strong>
        <br/> <br/>
        <table class="table-bordered table">
          <tr><th>Target Section (hide)</th><th>Source Section</th><th>DataGroup</th><th>Element</th><th>Value</th></tr>
          <tr ng-repeat="ew in selectedComposition.enableWhen">
            <td>{{ew.targetSection}}</td>
            <td>{{ew.sourceSection}}</td>
            <td>{{ew.dg}}</td>
            <td>{{ew.ed}}</td>
            <td>{{ew.value}}</td>
          </tr>
        </table>
        <em>Each row represents a source condition that must be true for the section to appear
          in a Form. There can be multiple - if any match then the section is shown.</em>
      </div>


      <br/>
      <p>Section level Conditionals are set in the 'Sections' tab</p>
      <!--
      <strong>DataGroup Conditionals present in the Composition</strong>
      <br/>
      <em>todo: enableWhen from all DG's in the comp</em>



      <table class="table table-bordered">
        <tr ng-repeat = "vo in allCompElements" ng-show="vo.ed.enableWhen">
          <td>{{vo.ed.path}}</td>
          <td>
            <div ng-repeat="ew in vo.ed.enableWhen">
              <div class="row">
                <div class="col-md-4">
                  <div>Source section: {{ew.sourceSection}}</div>
                  <div>Target section: {{ew.targetSection}}</div>
                </div>
                <div class="col-md-8">
                  <div>Path: {{ew.ed}}</div>
                  <div>Value: {{ew.value}}</div>
                </div>
              </div>



            </div>
          </td>
        </tr>
      </table>
       <pre>{{allCompElements | json}}</pre>

-->




    </uib-tab>

    <uib-tab heading="Form">

      <button class="btn-link btn pull-right" ng-click="previewQ(fullQ)">Examine Q</button>

      <renderform q="fullQ" qr="{}"></renderform>

    </uib-tab>

    <uib-tab heading="Graph">
      Graph of all DG linked back to Composition
    </uib-tab>

    <uib-tab>
      <uib-tab-heading>
        Overrides <span class="badge">{{getOverridesCount()}}</span>
      </uib-tab-heading>

      <table class="table table-bordered">
        <tr><th>Path</th><th>Title</th><th>ValueSet</th><th>Card.</th><th>Z</th><th></th></tr>
        <tr ng-repeat="ed in selectedComposition.override track by $index">
          <td>

            <div class="clickable" ng-click="selectCompTreePath(ed.path)">{{ed.path}}</div>
          </td>
          <td>{{ed.title}}</td>
          <td>{{ed.valueSet}}</td>
          <td>{{ed.mult}}</td>
          <td>{{ed.zElement}}</td>
          <td><button class="btn-link btn" ng-click="revertOverride(ed.path)">Revert</button> </td>
        </tr>
      </table>
    </uib-tab>

    <uib-tab heading = "MetaData">

      <div class="row">
        <div class="col-md-6">
          <table class="table">
            <tr>
              <td>Name</td>
              <td>{{selectedComposition.name}}</td>
            </tr>
            <tr>
              <td>Title</td>
              <td><input ng-disabled = "! canEditComp(selectedComposition)"
                      type="text" class="form-control" ng-model="selectedComposition.title" />  </td>
            </tr>
            <tr>
              <td>Description</td>
              <td><textarea ng-disabled = "! canEditComp(selectedComposition)"
                            class="form-control" ng-model="selectedComposition.description" ></textarea> </td>
            </tr>
            <tr>
              <td>Category</td>
              <td><input ng-disabled = "! canEditComp(selectedComposition)"
                         type="text" class="form-control"
                         ng-blur="updateMetaValues()"
                         ng-model="selectedComposition.meta.category" />  </td>
            </tr>

          </table>
        </div>
        <div class="col-md-6">
          <table class="table">

            <tr>
              <td>Tumour stream</td>
              <td><input ng-disabled = "! canEditComp(selectedComposition)"
                         type="text" class="form-control"
                         ng-blur="updateMetaValues()"
                         ng-model="selectedComposition.meta.tumourStream" /> </td>
            </tr>

            <tr>
              <td>Tags</td>
              <td>
                <div ng-repeat="tag in selectedComposition.meta.tags">
                  {{tag}}
                </div>
              </td>
            </tr>

            <tr>
              <td>Source reference</td>

              <td><input ng-disabled = "! canEditComp(selectedComposition)"
                         type="text" class="form-control" ng-model="selectedComposition.sourceReference" />  </td>

            </tr>


          </table>
        </div>
      </div>





    </uib-tab>






    <uib-tab ng-show="false" heading="allCompElements">
      <pre>{{hashCompElements | json}}</pre>
    </uib-tab>

    <uib-tab heading=" FSH">
      The FHIR shorthand that represents the composition as a FHIR Logical Model
    </uib-tab>

    <uib-tab heading = "Json">
      <pre>{{selectedComposition | json}}</pre>
    </uib-tab>
  </uib-tabset>


  </div>
</div>