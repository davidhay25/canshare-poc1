<div ng-controller="modelDGCtrl">


  <style>

    .myIcon {
      margin: 8px;
    }

    .hideElement {
      background-color: mistyrose;
    }

    .edIssue {
      background-color: mistyrose;
    }

  </style>



  <div ng-class="modelInfoClass">
    <div class="row">
      <div class="col-md-6">
        <strong>{{selectedModel.title}} </strong> ({{selectedModel.name}}) <em>{{selectedModel.description}}</em>
        <div>
          <div ng-if="selectedModel.sourceReference">
            <strong>Source reference</strong>: {{selectedModel.sourceReference}}
          </div>
        </div>

        <div ng-if = "canEdit(selectedModel)">
          <span class="clickable" ng-click="cloneDG(selectedModel)">Make a copy</span>

            <span class=" clickable spacer"
                 ng-click="editModel(selectedModel)">Edit</span>

            <span class=" clickable spacer"
                 ng-click="newModel('dg',selectedModel)">New child</span>

          <span ng-show="userMode == 'library'" class=" clickable spacer"
                ng-click="makeFrozen('dg',selectedModel)">Freeze a copy</span>

        </div>



        <br/>
        <div>

          <div class="row">
            <div class="col-md-6">
              <div ng-if="selectedModel.parent">
                <strong>Parents</strong>

                <div ng-repeat = "parent in relationshipsSummary.parents">
                  <span class="clickable" style="margin-left: 8px"
                        ng-click="termSelectDG({DGName:parent},selectedModel.name)">
                    {{hashAllDG[parent].title}}  <!--  ({{parent}}) -->
                  </span>
                </div>


              </div>

            </div>

            <div class="col-md-6">
              <strong>Direct children</strong> ({{relationshipsSummary.children.length}})
              <span ng-if="relationshipsSummary.children.length > 0"
                      class="clickable" ng-click="input.showDGChildren = ! input.showDGChildren">
                <span ng-if="input.showDGChildren">Hide</span>
                 <span ng-hide="input.showDGChildren">Show</span>
              </span>
              <div ng-if="input.showDGChildren"
                      ng-repeat = "child in relationshipsSummary.children">
                  <span class="clickable" style="margin-left: 8px"
                        ng-click="termSelectDG({DGName:child},selectedModel.name)">
                    {{hashAllDG[child].title}}  <!--  ({{parent}}) -->
                  </span>
              </div>
            </div>


          </div>

        </div>

        <br/>


      </div>
      <div class="col-md-6">

      <button class="btn btn-link" ng-click="deleteDG(selectedModel.name)">Delete</button>

      <a class="btn btn-link"
         ng-if="! canEdit(selectedModel)"
         ng-href="modelReview.html?{{selectedModel.name}}" target="_blank">Review</a>




        <button class="btn btn-link" ng-click="loadReview('dg')">Questionnaire</button>

      <button class="btn btn-link" ng-click="showLink('dg')">Link</button>

      <div class="pull-right">
        <div ng-if="user.email && (userMode == 'library')">



          <button class="btn btn-success"
                  ng-hide="selectedModel.checkedOut" class="clickable" ng-click="checkOut()">Check out</button>

          <button class="btn btn-danger"
                  ng-if="selectedModel.checkedOut && selectedModel.checkedOut == user.email"  ng-click="revert()">Revert</button>

          <button class="btn btn-warning"
                  ng-if="selectedModel.checkedOut && selectedModel.checkedOut == user.email"  ng-click="checkIn()">Check in</button>



          <div ng-if = "selectedModel.checkedOut && selectedModel.checkedOut !== user.email">
            <strong>Checked out to {{selectedModel.checkedOut}}</strong>
          </div>
        </div>
      </div>

     <div> <strong>FHIR resource:</strong>{{snapshotSvc.getExtractResource(selectedModel.name) }}</div>

      <table class="table table-condensed" style="margin-top: 8px">

        <tr><td>Tags</td>
          <td>

            <div class="row">
              <div class="col-md-6">
                <div ng-repeat = "tag in getTagListForDG(selectedModel) track by $index">
                  <div>

                    {{tag}}

                      <i class="glyphicon glyphicon-remove-sign pull-right clickable"
                         uib-popover="Remove this tag"
                         popover-placement="left"
                         popover-trigger="'mouseenter'"

                         ng-click="removeTagFromDT(tag,selectedModel)"></i>


                  </div>
                </div>

                <div class="row">
                  <div class="col-md-8">
                    <input type="text" class = "form-control" placeholder="New tag" ng-model = "input.newBespokeTag"/>
                  </div>
                  <div class="col-md-4">
                    <i class="glyphicon glyphicon-plus-sign pull-right"
                       ng-if="input.newBespokeTag"
                      style="padding-top: 8px;color: green"
                       ng-click="addTagToDT(input.newBespokeTag)"></i>
                  </div>
                </div>


              </div>
              <div class="col-md-6">
                <select class="form-control" ng-model="input.newTag"
                        ng-options="tag for tag in tagNames"></select>
                <div ng-if="input.newTag">
                  <button class="btn btn-link pull-right" ng-click="addTagToDT(input.newTag)">Add this tag</button>
                </div>

              </div>
            </div>



          </td>
        </tr>

      </table>

      <div ng-if = "hxDGLoad.length > 0">
        <div ng-click="back()" class="clickable pull-right">
          Reload {{ hashAllDG[hxDGLoad[hxDGLoad.length-1]].title }}
        </div>

      </div>

    </div>
  </div>
  </div>



  <uib-tabset  active="input.dgTabActive">



    <uib-tab heading="Tree">
      <br/>
      <div class="row">
        <div class="col-md-6" >
          <div class="background">
            <div class="pull-right">
              <div class="clickable myIcon" ng-click="expandDTTree()">Expand all ({{fullElementList.length -1}})</div>
              <!--
              <div class="clickable myIcon" ng-click="showSSLog(selectedModel.name)">Snapshot log</div>
-->
              <div class="clickable myIcon"
                   ng-hide="selectedModel.ssOrder"
                   ng-click="setOrder()">Set order</div>

              <div class="clickable myIcon"
                   ng-if="selectedModel.ssOrder"
                   ng-click="setOrder()">Update order</div>


              <div class="clickable myIcon"
                   ng-if="selectedModel.ssOrder"
                   ng-click="removeOrder()">Remove order</div>

            </div>




            <div id="dgTree"></div>

          <div>
          <button class="btn btn-link pull-right" ng-if="canEdit(selectedModel)"
                  ng-click="editDGItem()">Add new element <span ng-if="selectedNode">to {{selectedNode.data.ed.path}}</span></button>
          </div>
          <br/><br/>
        <div><em>Legend:</em></div>
          <div><strong style="margin-left: 8px">Bold</strong> elements are required</div>
          <div><span style="color: blue; margin-left: 8px">Blue</span>  elements have a fixed value</div>
          <div style=" margin-left: 8px">A trailing <strong>*</strong> indicates element can repeat.</div>
          <div style=" margin-left: 8px"><span style="text-decoration: line-through">Strike-through</span> indicates the element does not appear in a Q</div>
          <div style=" margin-left: 8px">
            <span style="text-decoration-line: underline;text-decoration-style: dotted">
              Dotted underline</span> indicates the element is subject to conditional show in the Q</div>
          </div>
        </div>
        <div class="col-md-6 ">

          <div class="background" ng-if="selectedNode.data.ed">
          <div ng-if="selectedNode.data.ed">


          <div class="row">
            <div class="col-md-4">

            </div>
            <div class="col-md-8">


              <button class="btn btn-link pull-right"

                      ng-if="canSlice(selectedNode.data.ed) && canEdit(selectedModel)"

                      ng-click="slice(selectedNode.data.ed)">Slice</button>
            </div>
          </div>


            <div ng-if = "selectedNode.data.ed.kind == 'root'">
              <table class="table table-bordered table-condensed">
                <tr><td>Name</td><td>{{selectedModel.name}}</td></tr>
                <tr><td>Description</td><td>{{selectedModel.description}}</td></tr>
                <tr ng-if="selectedModel.type"><td>Resource type</td><td>{{selectedModel.type}}</td></tr>
                <tr ng-if="selectedModel.sourceReference"><td>Source reference</td><td>{{selectedModel.sourceReference}}</td></tr>
                <tr ng-if="selectedModel.checkedOut"><td>Checked out</td>
                  <td>{{selectedModel.checkedOut}}</td></tr>

                <tr ng-if="dgNamedQueries.length > 0"><td>Named Queries</td>
                  <td>

                    <div ng-repeat = "nq in dgNamedQueries">
                      <div class="clickable" ng-click="testxquery(nq.name)">{{nq.itemName}} </div>


                    </div>


                  </td>
                </tr>

                <tr ng-if="selectedModel.fixedValues"><td>Fixed values</td>
                  <td>
                    <div ng-repeat = "fv in selectedModel.fixedValues">

                      <div>{{fv.path}}</div>
                      <div style="padding-bottom: 6px"><em  style="padding-left: 8px">{{fv.value}}</em></div>

                    </div>

                  </td>
                </tr>



              </table>

            </div>





            <uib-tabset ng-hide="selectedNode.data.ed.kind == 'root'">

              <button class="btn-link btn pull-right"
                      ng-if="selectedNode && canEdit(selectedModel)"
                      ng-click="editDGItem(selectedNode.data)">Edit </button>

              <uib-tab heading="Details">
                <table class="table table-bordered table-condensed">

                  <tr ng-if = "selectedNode.data.ed.path !== selectedModel.name">
                    <td class="detailName" style="width : 20%">Path</td>
                    <td>
                      {{selectedNode.data.ed.path | dropFirstInPath}}


                      <!--  <span class="pull-right clickable" ng-click="hideInQ(selectedNode.data.ed)"> -->
                      <span class="pull-right" >
                        <span ng-if="selectedNode.data.ed.hideInQ">Not shown in Q</span>
                        <span ng-hide="selectedNode.data.ed.hideInQ">Appears in Q</span>
                      </span>

                    </td>
                  </tr>

                  <tr>
                    <td class="detailName" style="width : 20%">Source model</td>
                    <td>

                      <div ng-hide="selectedNode.data.ed.sourceModelName == selectedModel.name"
                           class="pull-right clickable"
                           style="padding-right: 12px"
                           ng-click="termSelectDG({DGName:selectedNode.data.ed.sourceModelName},selectedModel.name)">
                        Load
                      </div>


                      {{hashAllDG[selectedNode.data.ed.sourceModelName].title}}

                      <div class = 'clickable'
                            ng-click="termSelectDG({DGName:selectedNode.data.ed.sourceModelName},selectedModel.name)">
                        <em>{{selectedNode.data.ed.sourceModelName}}</em></div>


                    </td>
                  </tr>

                  <tr>
                    <td class="detailName" style="width : 20%">Present in diff</td>
                    <td>

                      <div ng-if="presentInDiff(selectedNode.data.ed.path)">
                        There is an entry in the diff for this path
                      </div>

                      <div ng-hide ="presentInDiff(selectedNode.data.ed.path)">
                        There is no diff entry
                      </div>


                    </td>
                  </tr>


                  <tr><td class="detailName" style="width : 20%">Title</td>
                    <td>

                   {{selectedNode.data.ed.title}}</td>
                  </tr>

                  <tr><td class="detailName">Description</td><td>

                    {{selectedNode.data.ed.description}}
                  </td></tr>

                  <tr><td class="detailName">Type</td>
                    <td>

                      <div ng-repeat="type in selectedNode.data.ed.type">


                      <div ng-if="fhirDataTypes.indexOf(type) > -1" class="pull-right">
                        <a style="padding-right: 12px" target = "_blank" ng-href="{{fhirRoot}}datatypes.html#{{type}}">Details in spec </a>
                      </div>


                      <div ng-hide="fhirDataTypes.indexOf(type) > -1" class="clickable"
                           style="padding-right: 12px"
                           ng-click="termSelectDG({DGName:type},selectedModel.name)">
                        {{type}}&nbsp;
                      </div>

                        <div ng-show="fhirDataTypes.indexOf(type) > -1">
                          {{type}}&nbsp;
                        </div>





                      <div ng-if="selectedNode.data.ed.type[0] == 'CodeableConcept'">
                        <div ng-if="selectedNode.data.ed.otherType">
                          'Other' type: {{selectedNode.data.ed.otherType}}
                        </div>
                      </div>

                    </div>
                    </td></tr>

                  <tr ng-if = "selectedNode.data.ed.path !== selectedModel.name && selectedNode.data.ed.type[0] !== 'Group'" && qControlOptions>
                    <td class="detailName">Input control</td>
                    <td>
                      <div class="row">
                        <div class="col-md-12">



                          {{selectedNode.data.ed.controlHint}}

                          <span ng-repeat = "opt in qControlOptions">
                            <input type="radio"
                                   ng-change="setControlHint(selectedNode.data.ed,opt)"
                                   ng-model="input.controlHint" value="{{opt}}"> {{opt}}
                          </span>


                        </div>

                      </div>

                    </td>


                    </td>
                  </tr>


                  <tr><td class="detailName">Cardinality</td><td>

                    {{selectedNode.data.ed.mult}}
                  </td></tr>

                  <tr ng-if="selectedNode.data.ed.type[0] == 'CodeableConcept'">
                    <td class="detailName">ValueSet</td>
                    <td>


                      <div>
                        <span ng-if="selectedNode.data.ed.valueSet"
                              ng-click="viewVS(selectedNode.data.ed.valueSet)"
                              class="clickable pull-right">View VS</span>

                      </div>
                      <div>{{selectedNode.data.ed.valueSet}}</div>

                    </td>
                  </tr>

                  <tr ng-if="selectedNode.data.ed.notes">
                    <td class="detailName">Notes</td>
                    <td>

                      {{selectedNode.data.ed.notes}}
                    </td>
                  </tr>

                  <tr ng-if="selectedNode.data.ed.rules">
                    <td class="detailName">Rules</td>
                    <td>
                      {{selectedNode.data.ed.rules}}
                    </td>
                  </tr>

                  <tr ng-if="selectedNode.data.ed.placeHolder">
                    <td class="detailName">Placeholder</td>
                    <td>
                      {{selectedNode.data.ed.placeHolder}}
                    </td>
                  </tr>

                  <tr ng-if="selectedNode.data.ed.autoPop">
                    <td class="detailName">Auto populated</td>
                    <td>
                      Yes
                    </td>
                  </tr>

                  <tr ng-if="selectedNode.data.ed.type[0] == 'CodeableConcept'">
                    <td class="detailName">Options</td>
                    <td>
                      <div ng-if="selectedNode.data.ed.options">
                        <span
                                ng-click = "editDGOptionsList(selectedNode.data.ed,true)"
                                class="clickable pull-right">View list</span>

                        There are {{selectedNode.data.ed.options.length}} options defined
                      </div>

                      <div ng-hide="selectedNode.data.ed.options">
                        There are no options defined
                      </div>

                    </td>
                  </tr>

                  <tr ng-if="selectedNode.data.ed.type[0] == 'Quantity'">
                    <td class="detailName">Units</td>
                    <td>


                      <span ng-repeat="unit in selectedNode.data.ed.units">
                        {{unit}}&nbsp;
                      </span>


                    </td>
                  </tr>

                  <tr ng-if="isFixedType(selectedNode.data.ed)">
                    <td class="detailName">Fixed value</td>

                    <td>
                      <div ng-if="selectedNode.data.ed.fixedCode">
                        {{selectedNode.data.ed.fixedCode}}
                      </div>

                      <div ng-if="selectedNode.data.ed.fixedRatio">
                        <div ng-if="selectedNode.data.ed.fixedRatio.numerator.unit">Numerator unit: {{selectedNode.data.ed.fixedRatio.numerator.unit}}</div>
                        <div ng-if="selectedNode.data.ed.fixedRatio.denominator.unit">Denominator unit: {{selectedNode.data.ed.fixedRatio.denominator.unit}}</div>
                        <div ng-if="selectedNode.data.ed.fixedRatio.denominator.value">Denominator value: {{selectedNode.data.ed.fixedRatio.denominator.value}}</div>
                      </div>

                      <div ng-if="selectedNode.data.ed.fixedQuantity">
                        <span ng-if = "selectedNode.data.ed.fixedQuantity.unit">
                          Unit: {{selectedNode.data.ed.fixedQuantity.unit}}
                        </span>

                        <span ng-if = "selectedNode.data.ed.fixedQuantity.value">
                          Value: {{selectedNode.data.ed.fixedQuantity.value}}
                        </span>

                      </div>


                      <div ng-if="selectedNode.data.ed.fixedCoding">
                        {{selectedNode.data.ed.fixedCoding.code}} | {{selectedNode.data.ed.fixedCoding.display}} | {{selectedNode.data.ed.fixedCoding.system}}
                      </div>

                      <span ng-if="selectedNode.data.ed.fixedCoding ||
                        selectedNode.data.ed.fixedQuantity || selectedNode.data.ed.fixedRatio"
                            class="pull-right">

                        <span ng-hide ="presentInDiff(selectedNode.data.ed.path)">
                          set on {{getSourceModelName(selectedNode.data.ed)}}
                        </span>


                      </span>

                      <div ng-if="selectedNode.data.ed.itemCode">
                        <em style="padding-left: 8px">item.code will be set to this value in the Questionnaire</em>
                      </div>

                    </td>
                  </tr>




                  <tr ng-if="isFixedType(selectedNode.data.ed)">
                    <td class="detailName">Default value</td>

                    <td>
                      <div ng-if="selectedNode.data.ed.defaultCode">
                        {{selectedNode.data.ed.defaultCode}}
                      </div>


                      <div ng-if="selectedNode.data.ed.defaultRatio">
                        <div ng-if="selectedNode.data.ed.defaultRatio.numerator.unit">Numerator unit: {{selectedNode.data.ed.defaultRatio.numerator.unit}}</div>
                        <div ng-if="selectedNode.data.ed.defaultRatio.denominator.unit">Denominator unit: {{selectedNode.data.ed.defaultRatio.denominator.unit}}</div>
                        <div ng-if="selectedNode.data.ed.defaultRatio.denominator.value">Denominator value: {{selectedNode.data.ed.defaultRatio.denominator.value}}</div>
                      </div>

                      <div ng-if="selectedNode.data.ed.defaultQuantity">
                        <span ng-if="selectedNode.data.ed.defaultQuantity.unit">
                          Unit: {{selectedNode.data.ed.defaultQuantity.unit}}
                        </span>
                        <span ng-if="selectedNode.data.ed.defaultQuantity.value">
                          Value: {{selectedNode.data.ed.defaultQuantity.value}}
                        </span>
                      </div>

                      <div ng-if="selectedNode.data.ed.defaultCoding">
                        {{selectedNode.data.ed.defaultCoding.code}} | {{selectedNode.data.ed.defaultCoding.display}} | {{selectedNode.data.ed.defaultCoding.system}}
                      </div>

                      <span ng-if="selectedNode.data.ed.defaultCoding  || selectedNode.data.ed.defaultQuantity"
                            class=" pull-right">

                        <span ng-if="getSourceModelName(selectedNode.data.ed) !== selectedModel.name">
                          set on {{getSourceModelName(selectedNode.data.ed)}}
                        </span>



                      </span>

                    </td>
                  </tr>

                  <tr ng-if="selectedNode.data.ed.sourceReference">
                    <td class="detailName">Source reference</td>
                    <td>

                      {{selectedNode.data.ed.sourceReference}}
                    </td>
                  </tr>


                  <tr ng-if="selectedNode.data.ed.definition">
                    <td class="detailName">Extraction</td>
                    <td>

                      {{selectedNode.data.ed.definition}}
                    </td>
                  </tr>

                  <tr ng-if="selectedNode.data.ed.identifierSystem">
                    <td class="detailName">Identifier system</td>
                    <td>
                      {{selectedNode.data.ed.identifierSystem}}
                    </td>
                  </tr>


                  <tr ng-if="selectedNode.data.ed.extractExtensionUrl">
                    <td class="detailName">Extension Url</td>
                    <td>
                      {{selectedNode.data.ed.extractExtensionUrl}}
                    </td>
                  </tr>

                  <tr ng-if="selectedNode.data.ed.prePop">
                    <td class="detailName">Prepop</td>
                    <td>

                      {{selectedNode.data.ed.prePop}}
                    </td>
                  </tr>

                  <tr ng-if="selectedNode.data.ed.collapsible">
                    <td class="detailName">Collapsible</td>
                    <td>

                      {{selectedNode.data.ed.collapsible}}
                    </td>
                  </tr>

                  <tr ng-if="selectedNode.data.ed.sdcGrid">
                    <td class="detailName">Grid layout</td>
                    <td>
                      Child nodes in columns
                    </td>
                  </tr>

                  <tr ng-if="selectedNode.data.ed.selectedNQ">
                    <td  class="detailName">Selected Named query</td>
                    <td>


                      {{selectedNode.data.ed.selectedNQ}}

                    </td>
                  </tr>


                  <tr ng-if = "selectedNode.data.ed.insertAfter">
                    <td  class="detailName">Insert after</td>
                    <td>

                      {{selectedNode.data.ed.insertAfter | dropFirstInPath}}
                    </td>
                  </tr>

                </table>




              </uib-tab>

              <uib-tab>

                <uib-tab-heading>Conditional <span class="badge">
                  {{selectedNode.data.ed.enableWhen.length || 0}} | {{selectedNode.data.ed.conditionalVS.length || 0}}</span>
                </uib-tab-heading>
                <br/>


                <div ng-if = "selectedNode.data.ed.enableWhen">
                <strong>Element Show</strong>

                <table class="table table-bordered">
                  <tr><th>Source</th><th>Operator</th><th>Value</th></tr>
                  <tr ng-repeat="dep in selectedNode.data.ed.enableWhen">
                    <td>
                      {{dep.source | dropFirstInPath}}

                      <span ng-if="dep.source.split('.')[0] !== selectedModel.name">
                        <i style="color: red"
                           uib-popover="This source does not match an element in the DG: {{dep.source}}"
                           popover-placement="right"
                           popover-trigger="'mouseenter'"
                           class="pull-right glyphicon glyphicon-warning-sign"></i>


                      </span>

                    </td>

                    <td>{{dep.operator}}</td>
                    <td>
                      <div ng-if="dep.value.code">{{dep.value.code}} | {{dep.value.display}}</div>
                      <div ng-hide="dep.value.code">{{dep.value}}</div>
                    </td>
                    <td> <i style="color: red" class="glyphicon glyphicon-remove clickable"
                            ng-if = "canEdit(selectedModel)"
                            ng-click="removeEnableWhen($index,selectedNode.data.ed.path)"></i></td>
                  </tr>
                </table>
                <em ng-if="selectedNode.data.ed.enableWhen.length > 0">This element will be hidden in a form unless one of the above conditions is true</em>



                </div>

                <!-- TODO - come back to this after bug fixes -->
                <div ng-if="canEdit(selectedModel)" class="btn-link btn pull-right"
                     ng-click="addEWNew()">Add new control element</div>


                <div ng-if = "selectedNode.data.ed.conditionalVS">
                  <hr/>
                  <strong>Conditional ValueSet</strong>

                  <table class="table table-bordered">
                    <tr><th>Path</th><th>Value</th><th>ValueSet</th></tr>
                    <tr ng-repeat="row in selectedNode.data.ed.conditionalVS">
                      <td>{{row.path}}</td>
                      <td>{{row.value.display}}</td>
                      <td>{{row.valueSet}}</td>

                    </tr>
                  </table>

                </div>





              </uib-tab>

              <uib-tab heading="Json">
                New
                <pre>{{edForJsonDisplay | json}}</pre>
                Old
                <pre ng-if="selectedNode">{{selectedNode.data.ed | json}}</pre>

              </uib-tab>
            </uib-tabset>


            <br/><br/>
            <div ng-hide="selectedNode.data.ed.kind == 'root' || ! canEdit(selectedModel)">
              {{selectedNode.data.ed.title}}
              <!--
              <button class="btn-link btn" ng-click="hideInQ(selectedNode.data.ed)">
                Hide in Q
              </button>
-->
              <button class="btn-link btn" ng-click="deleteDGItem(selectedNode.data.ed)">
                Delete this item
              </button>

            </div>

          </div>

          <br/>

          </div>
        </div>
      </div>

    </uib-tab>


    <uib-tab heading="Views">
      <br/>
      <uib-tabset>


<!--
        <uib-tab  heading="Profile">
          The FHIR shorthand that represents this DataGroup as a FHIR Profile.
          Only includes elements marked as extractable
          <span class="pull-right">
       <i class="glyphicon glyphicon-paperclip pull-right clickable"
          ng-click="copyFshToClipboard(dgFshProfile)"></i>
      </span>
          <br/>
          <pre>{{dgFshProfile}}</pre>


        </uib-tab>
        -->

        <uib-tab heading="Table">
          <br/>
          <div class="tableFixHead">
            <table class="table-bordered table">
              <thead>
              <tr><th>Path</th><th>Title</th><th>Description</th><th>Type</th><th>Mult.</th><th>SDC attributes</th><th>Source</th></tr>
              </thead>
              <tbody>
              <!---     <tr ng-repeat="element in fullElementList">-->
              <tr ng-repeat="element in fullElementList"
                  ng-hide="$index==0 || (element.ed.mult.indexOf('..0') > -1)">
                <td>
                  <div  ng-style="{ 'padding-left': (element.ed.path | pathindent) }">
                    <div ng-hide="input.showFullModel">
                      {{element.ed.path | dropFirstInPath}}
                    </div>
                    <div ng-if="input.showFullModel">
                      {{element.ed.path | lastInPath}}
                    </div>
                  </div>


                </td>
                <td>{{element.ed.title}}</td>
                <td>

                  {{element.ed.description}}
                </td>
                <td>
                  <div ng-repeat="type in element.ed.type">
                    {{type}}
                  </div>
                  <div><em class="clickable" ng-click="viewVS(element.ed.valueSet)">{{element.ed.valueSet}}</em></div>

                  <div ng-if="element.ed.options.length > 0" >
                    <em class="clickable"
                        ng-click = "editDGOptionsList(element.ed)">View {{element.ed.options.length}} options
                    </em> </div>

                </td>
                <td>{{element.ed.mult}}</td>

                <td>
                  {{element.ed.fixedCode}}{{element.ed.fixedCoding}}
                  {{element.ed.fixedDecimal}}{{element.ed.fixedString}}
                  {{element.ed.fixedQuantity.value}} {{element.ed.fixedQuantity.unit}}

                  <div ng-if="element.ed.definition">Extract: {{element.ed.definition}}</div>
                  <div ng-if="element.ed.prePop">PrePop: {{element.ed.prePop}}</div>

                </td>
                <td>{{element.ed.sourceModelName}}</td>




              </tr>
              </tbody>
            </table>
          </div>

        </uib-tab>


        <uib-tab heading="Graph" select="fitGraph()">

          <em>Directly referenced DataTypes</em>
          <br/>
          <div class="row">
            <div class="col-md-6">
              <div id="graph"></div>
            </div>
            <div class="col-md-6">


              <uib-tabset ng-if="selectedModelFromGraph">

                <uib-tab heading="Table">

                  <div class="row">
                    <div class="col-md-2">Name:</div>
                    <div class="col-md-10">

                      <div class="clickable"
                           ng-if="selectedModelFromGraph.name !== selectedModel.name"
                           ng-click="termSelectDG({DGName:selectedModelFromGraph.name},selectedModel.name)">{{selectedModelFromGraph.name}}
                      </div>

                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-2">Title:</div>
                    <div class="col-md-10">{{selectedModelFromGraph.title}}</div>
                  </div>
                  <div class="row">
                    <div class="col-md-2">Description:</div>
                    <div class="col-md-10">{{selectedModelFromGraph.description}}</div>
                  </div>
                  <div ng-if="selectedModelFromGraph.parent" class="row">
                    <div class="col-md-2">Parent:</div>
                    <div class="col-md-10">
                      <div class="clickable"
                              ng-click="termSelectDG({DGName:selectedModelFromGraph.parent},selectedModel.name)">
                        {{selectedModelFromGraph.parent}}
                      </div>

                    </div>
                  </div>


                  <br/>

                  <uib-tabset>

                    <uib-tab heading="Full list">

                      <table class="table-bordered table table-condensed">
                        <tr><th>Path</th><th>Type</th><th>Card.</th></tr>
                        <tr ng-repeat="item in selectedModelFromGraphFull">
                          <td>
                            <div class="clickableDotted" uib-popover="{{item.ed.description}}"
                                 popover-placement="top"
                                 popover-trigger="'mouseenter'">{{item.ed.path | dropFirstInPath}}</div>

                          </td>
                          <td>{{item.ed.type[0]}}
                            <div class="clickable"><em ng-click="viewVS(item.ed.valueSet)">{{item.ed.valueSet}}</em></div>

                            <div><em>{{item.ed.fixedCoding}}</em></div>
                          </td>

                          <td>{{item.ed.mult}}</td>
                        </tr>
                      </table>
                      <em>These are all elements, including inherited</em>

                    </uib-tab>

                    <uib-tab heading="SDC">
                      <table class="table-bordered table">
                        <tr>
                          <td>FHIR resource type</td>
                          <td>{{snapshotSvc.getExtractResource(selectedModelFromGraph.name)}}</td>
                        </tr>
                      </table>

                      <table class="table-bordered table">
                        <tr ng-repeat="item in selectedModelFromGraphFull track by item.ed.path"
                            ng-if="item.ed.definition || item.ed.prePop">
                          <td>{{item.ed.path}}</td>
                          <td>
                            <div ng-show="item.ed.definition">Definition: {{item.ed.definition}}</div>
                            <div ng-show="item.ed.prePop">Pre-pop: {{item.ed.prePop}}</div>
                          </td>
                        </tr>
                      </table>

                    </uib-tab>

                    <uib-tab heading="Directly defined">
                      <table class="table-bordered table table-condensed">
                        <tr><th>Path</th><th>Type</th><th>Card.</th></tr>
                        <tr ng-repeat="ed in selectedModelFromGraph.diff">
                          <td>
                            <div class="clickableDotted" uib-popover="{{ed.description}}"
                                 popover-placement="right"
                                 popover-trigger="'mouseenter'">{{ed.path}}</div>


                          </td>
                          <td>{{ed.type[0]}}
                            <div class="clickable"><em>{{ed.valueSet}}</em></div>
                            <div><em>{{ed.fixedCoding}}</em></div>
                          </td>

                          <td>{{ed.mult}}</td>
                        </tr>
                      </table>
                      <em>This is only elements directly defined in the DG, including overrides</em>

                    </uib-tab>
                  </uib-tabset>


                </uib-tab>
                <uib-tab heading="DG Json">
                  <pre>{{selectedModelFromGraph | json}}</pre>
                </uib-tab>
              </uib-tabset>


            </div>
          </div>


        </uib-tab>

        <uib-tab heading="Logical Model">
          The FHIR shorthand that represents this DataGroup as a FHIR Logical Model.
          <span class="pull-right">
       <i class="glyphicon glyphicon-paperclip pull-right clickable"
          ng-click="copyFshToClipboard(dgFshLM)"></i>
      </span>
          <br/>
          <pre>{{dgFshLM}}</pre>


        </uib-tab>

        <uib-tab heading="Order element">
          <pre>{{selectedModel.ssOrder | json}}</pre>

        </uib-tab>

      </uib-tabset>





    </uib-tab>

<!--
    <uib-tab ng-if="false" heading="Graph" select="fitGraph()">

      <em class="pull-right">DT inheritance hierarchy and referenced DTs</em>
      <br/>
      <div class="row">
        <div class="col-md-6">
          <div id="graphXXX"></div>
        </div>
        <div class="col-md-6">


          <uib-tabset ng-if="selectedModelFromGraph">

            <uib-tab heading="Table">

              <div class="row">
                <div class="col-md-2">Name:</div>
                <div class="col-md-10">
                  {{selectedModelFromGraph.name}}

                  <div class="clickable pull-right"
                       ng-if="selectedModelFromGraph.name !== selectedModel.name"
                       ng-click="termSelectDG({DGName:selectedModelFromGraph.name},selectedModel.name)">Load
                  </div>

                </div>
              </div>
              <div class="row">
                <div class="col-md-2">Title:</div>
                <div class="col-md-10">{{selectedModelFromGraph.title}}</div>
              </div>


              <br/>

              <uib-tabset>
                <uib-tab heading="Directly defined">
                  <table class="table-bordered table table-condensed">
                    <tr><th>Path</th><th>Type</th><th>Card.</th></tr>
                    <tr ng-repeat="ed in selectedModelFromGraph.diff">
                      <td>
                        <div class="clickableDotted" uib-popover="{{ed.description}}"
                             popover-placement="right"
                             popover-trigger="'mouseenter'">{{ed.path}}</div>


                      </td>
                      <td>{{ed.type[0]}}
                        <div class="clickable"><em>{{ed.valueSet}}</em></div>
                        <div><em>{{ed.fixedCoding}}</em></div>
                      </td>

                      <td>{{ed.mult}}</td>
                    </tr>
                  </table>
                  <em>This is only elements directly defined in the DG, including overrides</em>

                </uib-tab>
                <uib-tab heading="Full list">

                  <table class="table-bordered table table-condensed">
                    <tr><th>Path</th><th>Type</th><th>Card.</th></tr>
                    <tr ng-repeat="item in selectedModelFromGraphFull">
                      <td>
                        <div class="clickableDotted" uib-popover="{{item.ed.description}}"
                             popover-placement="right"
                             popover-trigger="'mouseenter'">{{item.ed.path | dropFirstInPath}}</div>

                      </td>
                      <td>{{item.ed.type[0]}}
                        <div class="clickable"><em>{{item.ed.valueSet}}</em></div>
                        <div><em>{{item.ed.fixedCoding}}</em></div>
                      </td>

                      <td>{{item.ed.mult}}</td>
                    </tr>
                  </table>
                  <em>These are all elements, including inherited</em>

                </uib-tab>
              </uib-tabset>


            </uib-tab>
            <uib-tab heading="DG Json">
              <pre>{{selectedModelFromGraph | json}}</pre>
            </uib-tab>
          </uib-tabset>


        </div>
      </div>


    </uib-tab>
    -->



   <!--
<uib-tab ng-if="false" heading="Fixed values">
      todo: add other fixed types

      <br/>
      <div class="tableFixHead">
        <table class="table-bordered table">
          <thead>
          <tr><th>Path</th><th><th>Fixed value</th></tr>
          </thead>
          <tbody>
          <tr ng-repeat="ed in selectedModel.diff" ng-if="ed.fixedCoding">

            <td>{{ed.path}}</td>
            <td>{{ed.fixedCoding}}</td>

          </tr>
          </tbody>
        </table>
      </div>

    </uib-tab>
    -->

    <uib-tab heading="Relationships">

      <strong>DataGroups related to this one via the hierarchy</strong>
      <br/> <br/>
      <div class="row">
        <div class="col-md-3">

          <strong>Ancestry</strong>
          <br/>
          <div>
            <div ng-repeat="parent in relationshipsSummary.parents">
              <div class = 'clickable' ng-click="termSelectDG({DGName:parent},selectedModel.name)">{{hashAllDG[parent].title}}</div>
              <div>
                <i style="margin-left: 40px" class="glyphicon glyphicon-arrow-down"></i>
              </div>
            </div>

            <div ng-if="relationshipsSummary.parents.length > 0">
              <div  class="rounded-box">{{selectedModel.title}}</div>
            </div>

            <div  ng-if="relationshipsSummary.parents.length == 0">
              <em>There is no parent</em>
            </div>

          </div>

        </div>
        <div class="col-md-3">
          <strong>Direct children</strong>
          <br/>
          <div ng-repeat="child in relationshipsSummary.children">
            <div class = 'clickable' ng-click="termSelectDG({DGName:child},selectedModel.name)">{{hashAllDG[child].title}}</div>
          </div>

        </div>
        <div class="col-md-6">
          <strong>References directly from this DG</strong>
          <br/>


          <table class="table table-bordered">
            <tr><th>Path</th><th>Type</th></tr>
            <tr ng-repeat="reference in relationshipsSummary.references">
              <td>{{reference.path}}</td>
              <td>
                <div class = 'clickable' ng-click="termSelectDG({DGName:reference.dgName},selectedModel.name)">
                  {{reference.dgName}}
                </div>
              </td>
            </tr>
          </table>
<!--
          <table class="table table-bordered">
            <tr><th>Path</th><th>Type</th></tr>
            <tr ng-repeat="reference in relationshipsSummary.references">
              <td>{{reference.path}}</td>
              <td>
                <div class = 'clickable' ng-click="termSelectDG({DGName:reference.type},selectedModel.name)">
                  {{reference.type}}
                </div>
              </td>
            </tr>
          </table>

          -->

        </div>
      </div>

<hr/>

      <strong>DataGroups and Compositions that reference this one</strong>
      <table class="table table-bordered">
        <tr><th>Title (name)</th><th>Path</th><th>Kind</th><th>Card.</th><th>Mode</th></tr>

        <tr ng-repeat="item in xref[selectedModel.name] track by $index">
          <td>
            <div class="clickable" ng-click="selectModelFromList(item.name,item.kind)">
              {{item.title}} ({{item.name}})
            </div>


          </td>
          <td>{{item.path}}</td>
          <td>{{item.kind}}</td>
          <td>{{item.mult}}</td>
          <td>{{item.mode}}</td>
        </tr>
      </table>


<!--
      <pre>{{relationshipsSummary | json}}</pre>
-->
    </uib-tab>

    <uib-tab ng-if="false">
      <uib-tab-heading>Referenced by</uib-tab-heading>


      <table class="table table-bordered">
        <tr><th>Name</th><th>Path</th><th>Kind</th></tr>
        <tr ng-repeat="item in xref[selectedModel.name] track by $index">
          <td>
            <div class="clickable" ng-click="selectModelFromList(item.name,item.kind)">
              {{item.name}}
            </div>


          </td>
          <td>{{item.path}}</td>
          <td>{{item.kind}}</td>
        </tr>
      </table>





    </uib-tab>

    <uib-tab >



      <uib-tab-heading>
        Dependencies <span class="badge"> {{allDependencies.length}}</span>
      </uib-tab-heading>




      <h4>Dependencies</h4>

      <table class="table-bordered table">
        <tr><th>Target (what to hide)</th><th>Controlling element</th><th>Controller description</th><th>Op</th>
          <th>Value (that will show target)</th>


        </tr>
        <tr ng-repeat="dep in allDependencies">
          <td>
            <div class="clickable" ng-click="selectCondElement(dep.path)">
              {{dep.path | dropFirstInPath}}
            </div>

          </td>
          <td>{{dep.ew.source | dropFirstInPath}}</td>
          <td>{{dep.ed.description}}
            <div ng-if="dep.error">
              <div class="alert alert-danger">{{dep.error}}</div>
            </div>

          </td>
          <td>{{dep.ew.operator}}</td>
          <td>
            <div ng-if="dep.ew.value.code">{{dep.ew.value.code}} | {{dep.ew.value.display}}</div>
            <div ng-hide="dep.ew.value.code">{{dep.ew.value}}</div>
          </td>

        </tr>
      </table>

      <em>All of the hide / show dependencies in this DG</em>



    </uib-tab>


    <uib-tab>
      <uib-tab-heading>
        Ordering <span class="badge"> {{selectedModel.ordering.length}}</span>
      </uib-tab-heading>

      <br/>
      <div ng-controller="orderingCtrl">
        <ng-include src="'/includes/ordering.html'"></ng-include>
      </div>

      <hr/>
    </uib-tab>


    <uib-tab ng-if = "false" heading="Form">


     <!-- <div id="dgformlocation"></div> -->



<!--
     <renderform2 q="dgQ" hash-ed="hashAllDG" technicalview="true" treenode="dgformlocation"></renderform2>
      <pre>{{dgQ | json}}</pre>

      <button class="btn-link btn pull-right" ng-click="previewQ(dgQ)">Examine Q</button>
-->

<!-- - not working for some Q (procedure)

      <renderform q="dgQ" qr="{}" form="{}"></renderform>
-->

    </uib-tab>


<!--
    <uib-tab heading="Profiling">
      <br/>
      <div ng-controller="profilingDGCtrl">
        <ng-include src="'/includes/profilingDG.html'"></ng-include>
      </div>


    </uib-tab>

   -->




    <uib-tab>
      <uib-tab-heading>Diff <span class="badge">{{selectedModel.diff.length}}</span> </uib-tab-heading>
      <em>The element definitions in the .diff element. ie directly defined in the DG. The Json has the complete model.
      Clicking on an element in the table, selects it in the list (to see details)</em>
      <br/><br/>

<!--
      <button class="btn-link btn pull-right" ng-click="fixGroups()">Fix groups order in Diff</button>
      -->

      <uib-tabset>
        <uib-tab heading="Table">
          <table class="table-condensed table table-bordered">
            <thead style="position:sticky;top:0">
            <tr><th>Path</th><th>Title</th><th>Description</th><th>Card.</th><th>Type</th><th></th></tr>
            </thead>
            <tbody>
            <tr ng-repeat="ed in selectedModel.diff">
              <td>
                <div class="clickableDotted" ng-click="input.selectedDiff = ed">{{ed.path}}</div>
              </td>
              <td>{{ed.title}}</td>
              <td>{{ed.description}}</td>
              <td>{{ed.mult}}</td>
              <td>{{ed.type[0]}}</td>
              <td>
                <i ng-if="canEdit(selectedModel)" class="btn btn-link glyphicon glyphicon-remove clickable"
                   ng-click="deleteDGDiff($index)"></i>
              </td>
            </tr>
            </tbody>


          </table>
        </uib-tab>
        <uib-tab heading="List">
          <div class="row">
            <div class="col-md-6">
              <input class="form-control" placeholder="Filter on path" ng-model="input.diffFilter"/>

              <div class="list-group myScroll">
                <div ng-class="{'list-group-item':true,listItemSelected:input.selectedDiff.path == ed.path}"
                     ng-click="input.selectedDiff = ed"
                     ng-if="showDiff(input.diffFilter,ed.path)"
                     ng-repeat="ed in selectedModel.diff">
                  {{ed.path}}
                </div>
              </div>

            </div>
            <div class="col-md-6">
              <pre>{{input.selectedDiff | json}}</pre>
            </div>
          </div>

        </uib-tab>

      </uib-tabset>






    </uib-tab>


    <uib-tab>
      <uib-tab-heading>Snapshot <span class="badge">{{fullElementList.length -1}}</span></uib-tab-heading>



      <uib-tabset>
        <uib-tab heading="List">
          <div class="tableFixHead">
            <table class="table-bordered table">
              <thead>
              <tr><th>Path</th><th>Title</th>
                <th>Description</th><th>Type</th><th>Mult.</th><th>Source</th><th ng-if="canEdit(selectedModel)"><span >Edit</span></th>
              </tr>
              </thead>
              <tbody>

              <!---     <tr ng-repeat="element in fullElementList">-->
              <tr ng-repeat="element in fullElementList"
                  ng-class="{edIssue: element.ed.issue.length > 0}"
                  ng-if="$index > 0">




                <td>

                  <div ng-repeat = "segment in element.ed.path.split('.') track by $index">
                    {{segment}}
                  </div>

                  <div ng-repeat="issue in element.ed.issue track by $index">
                    <em>{{issue}}</em>
                  </div>

                  <!--
                                    <div  ng-style="{ 'padding-left': (element.ed.path | pathindent) }">

                                      <div ng-hide="input.showFullModel">
                                        {{element.ed.path | dropFirstInPath}}
                                      </div>
                                      <div ng-if="input.showFullModel">
                                        {{element.ed.path | lastInPath}}

                                      </div>
                                    </div>
                                    -->




                </td>


                <td>{{element.ed.title}}</td>
                <td>

                  {{element.ed.description}}
                </td>
                <td>
                  <div ng-repeat="type in element.ed.type">
                    {{type}}
                  </div>
                  <div><em class="clickable" ng-click="viewVS(element.ed.valueSet)">{{element.ed.valueSet}}</em></div>
                </td>
                <td>{{element.ed.mult}}</td>

                <td>{{getSourceModelName(element.ed)}}</td>

                <td ng-if="canEdit(selectedModel)">
                  <i class="glyphicon glyphicon-edit clickable"
                     ng-click="editDGItem(element)"></i>
                </td>

              </tr>
              </tbody>
            </table>
          </div>

        </uib-tab>
        <uib-tab heading="Json">
          <pre>{{fullElementList | json}}</pre>
        </uib-tab>
      </uib-tabset>

    </uib-tab>


    <uib-tab ng-if="false" heading="Audit">
      <!-- Audit only looks at hierarchy - not referenced DG-->
      <uib-tab-heading>Audit <span ng-if="dgAudit.lstRedundantEd.length > 0" class="badge">{{dgAudit.lstRedundantEd.length}}</span> </uib-tab-heading>
        <br/>
        <uib-tabset>

          <uib-tab heading="Diff Analysis">

            <div ng-if="dgAudit.lstRedundantEd.length > 0">
              <h4>Redundant diff entries - no matching parent element</h4>
              <table class="table-bordered table">
                <tr><th>Path</th><th>Title</th><th>Type</th><th>Card.</th></tr>
                <tr ng-repeat="row in dgAudit.lstRedundantEd">
                  <td>{{row.path}}</td>
                  <td>{{row.title}}</td>
                  <td>{{row.type[0]}}</td>
                  <td>{{row.mult}}</td>
                </tr>
              </table>
              <div>
                <div class="btn btn-link pull-right" ng-click="deleteAllRedundantDiff()">Delete all redundant diff</div>
              </div>
              <div class="clearfix"></div>

            </div>




            <h4>Diff entries that match a parent element</h4>
            <table class="table-bordered table">
              <tr><th>Path</th><th>Where defined</th><th>Type</th><th>Card.</th></tr>
              <tr ng-repeat="row in dgAudit.allElements" ng-if="row.mult == '0..0'">
                <td>{{row.path}}</td>
                <td>{{row.definedTitle}}</td>
                <td>{{row.type[0]}}</td>
                <td>{{row.mult}}</td>
              </tr>
            </table>



          </uib-tab>


          <uib-tab heading="All elements">

            <div class="row">
              <div class="col-md-12">
                <h4>All elements</h4>
                <table class="table-bordered table">
                  <tr><th>Path</th><th>Where defined</th><th>Type</th><th>Card.</th></tr>
                  <tr ng-repeat="row in dgAudit.allElements" ng-if="row.mult !== '0..0'">
                    <td>{{row.path}}</td>
                    <td>{{row.definedTitle}}</td>
                    <td>{{row.type[0]}}</td>
                    <td>{{row.mult}}</td>
                  </tr>
                </table>
              </div>
              <div class="col-md-0">



              </div>
            </div>



          </uib-tab>
          <uib-tab heading="Json">
            <pre>{{dgAudit | json}}</pre>
          </uib-tab>
        </uib-tabset>





    </uib-tab>

    <uib-tab heading="Json">
      <em>The definition for this model (not expanded)</em>
      <span class="pull-right">
       <i class="glyphicon glyphicon-paperclip pull-right clickable"
          ng-click="copyToClipboard(selectedModel)"></i>
      </span>
      <pre>{{selectedModel | json}}</pre>
    </uib-tab>


  </uib-tabset>


</div>