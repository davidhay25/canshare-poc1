<!DOCTYPE html>
<html lang="en">
<head>
    <base href="/">
    <meta charset="UTF-8">
    <title>Terminology maintenance</title>

    <script src="js/libs/jquery-1.9.0.min.js"></script>
    <script src="js/libs/angular.min1-5.js"></script>
    <script src="js/libs/ui-bootstrap-tpls-2.0.1.min.js"></script>
    <script src="js/libs/moment.min.js"></script>

    <script src="js/libs/ngStorage.min.js"></script>

    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/common.css"/>
    <link rel="stylesheet" type="text/css" href="css/vis.min.css"/>

    <!--
    <style>
        .retired {
            background-color: lightsalmon;
        }
    </style>
    -->

    <script>
        angular.module("pocApp",['ui.bootstrap','ui.checkbox',"firebase",'ngStorage']).config(function($locationProvider) {
            $locationProvider.html5Mode(true);
            $locationProvider.hashPrefix('!');
        });
        angular.module("pocApp").constant("moment", moment);

        angular.module("pocApp").config(['$compileProvider', function ($compileProvider) {
            $compileProvider.aHrefSanitizationWhitelist(/^\s*(http|https?|ftp|mailto|blob):/);
        }]);

        angular.module("formsApp",[])
        angular.module('topApp', ['pocApp', 'formsApp'])

    </script>



    <script src="js/libs/angular-bootstrap-checkbox.js"></script>
    <script src="js/updateVSCtrl.js"></script>
    <script src="js/querySvc.js"></script>
    <script src="js/updateVSSvc.js"></script>
    <script src="js/showParameters.js"></script>
    <script src="js/loginCtrl.js"></script>
    <script src="js/utilsSvc.js"></script>
    <script src="js/viewVSCtrl.js"></script>

    <script src="js/terminologyUpdateSvc.js"></script>


    <script src="js/filters.js"></script>
    <script src="js/customCodeSystemCtrl.js"></script>

    <script src="js/libs/firebase.js"></script>
    <script src="js/libs/angularfire.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDG1ToLHycsMUX0CfX0OZVSRUUpFQeKE9o",
            authDomain: "canshare-730e6.firebaseapp.com",
            projectId: "canshare-730e6",
            storageBucket: "canshare-730e6.appspot.com",
            messagingSenderId: "12147821347",
            appId: "1:12147821347:web:5963d577cb050259475a96"
        };
        if (firebase) {
            console.log('init firebase')
            firebase.initializeApp(firebaseConfig);

        }
    </script>

</head>
<body style="padding: 8px;padding-top: 80px">
<div ng-app="topApp" ng-controller="updateCtrl" class="container-fluid">

    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">

        <div class="container-fluid">
            <div class="col-md-4">
                    <span>
                        <a class="navbar-brand" href="#">
                            Terminology maintenance
                        </a>
                    </span>

            </div>

            <div class="col-md-3">
                <div class="navbar-text">
                    Number of ValueSets:
                    <span class="badge">{{allVSItem.length}}</span>
                </div>

            </div>

            <div class="col-md-1">
                <div class="navbar-text" >
                    <div class="pull-right btn">{{version}}</div>
                </div>
            </div>

            <div class="col-md-1 col-sm-1">
                <form class="navbar-form navbar-left">
                    <img ng-show="showWaiting" src="css/ajax_loader_blue_32.gif"/>

                </form>
            </div>

            <div class="col-md-1 col-sm-1">
                <div class="navbar-text " ng-hide="user">
                    <span style="font-size:1.2em; cursor: pointer" uib-popover="Click to log in"
                          popover-placement="left"
                          popover-trigger="'mouseenter'">
                        <div ng-click="login()">
                            <i class="glyphicon glyphicon-log-in"></i>
                        </div>
                    </span>
                </div>

                <div class="navbar-text"  ng-show="user">
                    <span style="font-size:1.2em;  cursor: pointer" uib-popover="{{user.email}}"
                          popover-placement="left"
                          popover-trigger="'mouseenter'">
                        <div ng-click="logout()">
                            <i class="glyphicon glyphicon-log-out"></i>
                        </div>
                    </span>
                </div>

            </div>



            <div class="col-md-2">
                <a href="https://teaho.govt.nz/" target="_blank">
                    <img width="150" height="auto" class="pull-right"
                         style="padding: 3px"
                         src="images/TAK-logo-midgreen.png"/>
                </a>
            </div>
        </div>
    </nav>

    <button ng-hide = "showWaitingTimeout" style="margin-right: 8px"
            ng-click="setSyndicationStatus()"
            class="btn-danger btn pull-right">Set Syndication status</button>


    <button class="btn btn-info pull-right" ng-show = "showWaitingTimeout" style="margin-right: 8px">
        Syndicating. Progress: {{syndProgress}}
    </button>




    <uib-tabset active="input.topTabActive">



        <uib-tab heading="Edit ValueSet">
            <br/>

            <div class="row">
                <div class="col-md-4">

                    <uib-tabset>
                        <uib-tab heading="Alphabetical">
                            <br/>
                            <div class="row">

                                <div class="col-md-6">
                                    <checkbox ng-model="input.includeRetired"></checkbox> Include retired & draft
                                </div>

                                <div class="col-md-6">
                                    <button class="btn-link btn pull-right" ng-click="createNew()">New</button>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12">
                                    <input placeholder="Filter" type="text" class="form-control" ng-model="input.filterlist"/>
                                    <br/>
                                    <div class="myScroll">
                                        <div class="list-group">
                                            <div ng-class="{'list-group-item':true,listItemSelected:selectedItem.vs.id==item.vs.id,retiredVS:item.vs.status == 'retired',draftVS:item.vs.status == 'draft'}"
                                                 ng-show="showVS(item)"
                                                 style="cursor: pointer" ng-repeat="item in allVSItem" ng-click="selectVSItem(item)">
                                                {{item.display}}

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </uib-tab>

                        <uib-tab  heading="Last updated">
                            <div class="myScroll">
                                <div class="list-group">
                                    <div ng-class="{'list-group-item':true,listItemSelected:selectedItem.vs.id==item.vs.id,retiredVS:item.vs.status == 'retired',draftVS:item.vs.status == 'draft'}"
                                         style="cursor: pointer" ng-repeat="item in sortedVS" ng-click="selectVSItem(item)">
                                        <div>{{item.display}}</div>
                                        <div class="pull-right"><em>{{item.vs.meta.lastUpdated | ageSeconds}}</em></div>
                                        <div class="clearfix"></div>
                                    </div>
                                </div>
                            </div>

                        </uib-tab>
                        <uib-tab  heading="Bespoke query">
                            <textarea class="form-control" ng-model="input.bespoke"
                                      placeholder="Enter query - eg ValueSet?name=cs"></textarea>

                            <button class="btn-link btn" ng-click="executeBespoke(input.bespoke)">Execute</button>
                        </uib-tab>
                    </uib-tabset>



                </div>


                <div ng-show="selectedVS" class="col-md-8">

                    <div class="alert-info alert" ng-hide="user">
                        Update and Create operations on the publishing Server can only be done by
                        logged in users
                    </div>

                    <div class="banner">
                        {{selectedVS.title}}
                    </div>

                    <div>

                        <button ng-show = "user && user.email && canSave()" class="btn btn-danger pull-right">
                            <span ng-show="isNew" ng-click="newVS()">Save new VS</span>
                            <span ng-hide="isNew" ng-click="updateVS(selectedVS)">Update VS</span>
                        </button>


                    </div>



                    <uib-tabset active="input.mainTabActive">

                        <uib-tab heading="Edit ValueSet">
                            <table class="table">
                                <tr>
                                    <td>Id</td>
                                    <td>
                                        <div class="row">
                                            <div class="col-md-9">
                                                <input type="text"
                                                       ng-disabled="! isNew"
                                                       ng-blur = checkNewVS(input.id)
                                                       class="form-control" ng-model="input.id"/>
                                            </div>
                                            <div class="col-md-3">
                                                <button
                                                        ng-click="showLink(input.id)"
                                                        class="pull-right btn btn-link">Link to ValueSet</button>
                                            </div>
                                        </div>






                                    </td>
                                </tr>

                                <tr>
                                    <td>VS Status</td>
                                    <td>
                                        <select ng-model="input.status" class="form-control" ng-change = makeVS()>
                                            <option value="active">Active</option>
                                            <option value="retired">Retired</option>
                                            <option value="draft">Draft</option>
                                        </select>
                                    </td>
                                </tr>

                                <tr>
                                    <td>Syndication Status</td>
                                    <td>
                                        {{syndicationStatus}}
                                    </td>
                                </tr>

                                <tr>
                                    <td>Last updated</td>
                                    <td>
                                        {{selectedVS.meta.lastUpdated | date}}
                                    </td>
                                </tr>

                                <tr ng-show="false">
                                    <td>Member count</td>
                                    <td>
                                        <span class="badge">{{getMemberCount(selectedVS)}}</span>

                                        <div ng-show="false" class="btn-link btn pull-right" ng-click="updateMemberCount(selectedVS)">Refresh member count</div>

                                    </td>
                                </tr>






                                <tr>
                                    <td>Title</td>
                                    <td>
                                        <input type="text" class="form-control" ng-change = makeVS() ng-model="input.title"/>
                                    </td>
                                </tr>

                                <tr>
                                    <td>Description</td>
                                    <td>
                                        <textarea class="form-control" ng-change = makeVS() ng-model="input.description"></textarea>
                                    </td>
                                </tr>

                                <tr>
                                    <td>ECL

                                        <div ng-show = "testEclVS.expansion.contains.length > 0">
                                            <br/>
                                            <em>{{testEclVS.expansion.contains.length}} concepts </em>
                                        </div>

                                    </td>
                                    <td>
                                        <div class="row">
                                            <div class="col-md-10">
                                                <textarea class="form-control" ng-change = makeVS() ng-model="input.ecl"></textarea>

                                            </div>
                                            <div class="col-md-2">
                                                <button
                                                        ng-show="input.ecl"
                                                        class="btn btn-link" ng-click="listConcepts(input.ecl)">Test ECL</button>
                                            </div>
                                        </div>

                                    </td>
                                </tr>



                                <tr>
                                    <td  width = "20%">Display concepts
                                        <div><br/><em>Published concepts where the description is incorrect</em></div>
                                    </td>
                                    <td>

                                        <table class="table table-bordered">
                                            <tr><th>Code</th><th>Display</th><th></th></tr>
                                            <tr ng-repeat="concept in input.displayConcepts">
                                                <td>
                                                    {{concept.code}}
                                                </td>
                                                <td>{{concept.display}}</td>
                                                <td><i style="color: red" class="glyphicon glyphicon-remove clickable"
                                                       ng-click="removeDisplayConcept($index)"></i></td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <div class="row">
                                                        <div class="col-md-10">
                                                            <input ng-model="input.newDisplayCode" type="text" class="form-control"/>
                                                        </div>
                                                        <div class="col-md-2">
                                                            <i style="color: orange" class="glyphicon glyphicon-question-sign clickable"
                                                               ng-show="input.newDisplayCode"
                                                               ng-click="getDisplay(input.newDisplayCode,'newDisplayDisplay')"></i>
                                                        </div>
                                                    </div>

                                                </td>
                                                <td><input ng-model="input.newDisplayDisplay" type="text" class="form-control"/> </td>
                                                <td>


                                                    <i style="color: green" class="glyphicon glyphicon-ok clickable"
                                                       ng-show="input.newDisplayCode && input.newDisplayDisplay"
                                                       ng-click="addDisplayConcept()"></i>

                                                </td>
                                            </tr>

                                        </table>
                                    </td>
                                </tr>





                                <tr>
                                    <td>Unpublished concepts
                                        <div><em><br/>Concepts created but not yet published. They are in a separate CodeSystem</em></div>

                                        <div ng-show = "input.prePubConcepts.length > 0">
                                            <br/>
                                            <em>{{input.prePubConcepts.length}} concepts</em>
                                        </div>

                                    </td>
                                    <td>

                                        <table class="table table-bordered">
                                            <tr><th>Code</th><th>Display</th><th></th></tr>
                                            <tr ng-repeat="concept in input.prePubConcepts">
                                                <td>
                                                    {{concept.code}}
                                                </td>
                                                <td>{{concept.display}}</td>
                                                <td><i style="color: red" class="glyphicon glyphicon-remove clickable"
                                                       ng-click="removePPConcept($index)"></i></td>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <div class="row">
                                                        <div class="col-md-10">
                                                            <input ng-model="input.newPPCode" type="text" class="form-control"/>
                                                        </div>
                                                        <!--
                                                        <div class="col-md-2">
                                                            <i style="color: orange" class="glyphicon glyphicon-question-sign clickable"
                                                               ng-show="input.newPPCode"
                                                               ng-click="getDisplay(input.newPPCode,'newPPDisplay')"></i>
                                                        </div>
                                                        -->
                                                    </div>




                                                </td>
                                                <td><input ng-model="input.newPPDisplay" type="text" class="form-control"/> </td>
                                                <td>


                                                    <i style="color: green" class="glyphicon glyphicon-ok clickable"
                                                       ng-show="input.newPPCode && input.newPPDisplay"
                                                       ng-click="addPPConcept()"></i>

                                                </td>
                                            </tr>

                                        </table>
                                    </td>
                                </tr>


                            </table>

                            <div ng-show="testEclVS">
                                <strong>ECL result</strong> {{testEclVS.expansion.contains.length}} concepts
                                <table class="table table-bordered table-condensed">
                                    <tr><th>Display</th><th>Code</th><th>System</th></tr>
                                    <tr ng-repeat="concept in testEclVS.expansion.contains">
                                        <td>{{concept.display}}</td>
                                        <td>
                                            <div  class="clickable" ng-click="lookup(concept.code)">{{concept.code}}</div></td>
                                        <td>{{concept.system}}</td>
                                    </tr>
                                </table>

                            </div>


                        </uib-tab>

                        <uib-tab heading="Expand">
                            <br/>
                            <div class="row">

                                <div class="col-md-3">
                                    <input type="text" class="form-control" ng-model="input.filter" placeholder="Filter text"/>
                                </div>
                                <div class="col-md-3">
                                    <div ng-show="expandedVS.expansion.contains">{{expandedVS.expansion.contains.length}} concepts</div>
                                </div>

                                <div class="col-md-6">
                                    <button class="btn btn-primary pull-right" ng-click="expandVSInTS(selectedVS)">Expand</button>
                                </div>
                            </div>
                            <br/>
                            <div ng-show="expandQry">Query: {{expandQry}}</div>
                            <br/>



                            <uib-tabset ng-show="expandedVS">
                                <uib-tab heading="Concepts">
                                    <div class="myScroll">
                                        <table class="table table-bordered table-condensed">
                                            <tr><th>Display</th><th>Code</th><th>System</th></tr>
                                            <tr ng-repeat="concept in expandedVS.expansion.contains">
                                                <td>{{concept.display}}</td>
                                                <td>
                                                    <div  class="clickable" ng-click="lookup(concept.code)">{{concept.code}}</div></td>
                                                <td>{{concept.system}}</td>
                                            </tr>
                                        </table>
                                    </div>


                                </uib-tab>
                                <uib-tab heading="Json">
                                    <pre>{{expandedVS | json}}</pre>
                                </uib-tab>
                            </uib-tabset>






                        </uib-tab>

                        <uib-tab heading="Json">
                            <pre>{{selectedVS | json}}</pre>
                        </uib-tab>

                        <!--

                        <uib-tab>
                            <uib-tab-heading>Unpublished concepts <span class="badge">{{prePubCS.concept.length}}</span>
                            </uib-tab-heading>
                            <br/>
                            <em>This is the custom ValueSet for unpublished concepts. These are concepts that have been defined
                                in SNOMED but not yet published. They have a different system url (as they don't yet exist in the
                                Terminology Server). If they are used by an implementer, then they will be responsible for making
                                any changes required once the concepts are formally published. </em>
                            <uib-tabset>
                                <uib-tab heading="Table">
                                    <br/>
                                    <table class="table table-bordered">
                                        <tr><th>Code</th><th>Display</th></tr>
                                        <tr ng-repeat="concept in prePubCS.concept">
                                            <td>{{concept.code}}</td>
                                            <td>{{concept.display}}</td>

                                        </tr>
                                    </table>

                                </uib-tab>
                                <uib-tab heading="Json">
                                    <pre>{{prePubCS | json}}</pre>

                                </uib-tab>
                            </uib-tabset>




                        </uib-tab>

                        -->

                        <uib-tab heading="History">
                            <button class="btn btn-link pull-right" ng-click="getVersions(selectedVS)">Load versions</button>

                            <div class="clearfix"></div>
                            <br/>

                            <div class="row">
                                <div class="col-md-2">
                                    <div class="myScroll">
                                        <div class="list-group">
                                            <div class="list-group-item"
                                                 style="cursor: pointer"
                                                 ng-click = "selectVersion(entry.resource)"
                                                 ng-repeat = "entry in bundleVersions.entry">
                                                {{entry.resource.meta.lastUpdated | date : "d MMM HH:mm"}}

                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-10">
                                    <div ng-show="selectedVersion">

                                        <div>Title: {{selectedVersion.title}}</div>
                                        <div>Description: {{selectedVersion.description}}</div>
                                        <div>Updated: {{selectedVersion.meta.lastUpdated | date : "d MMM HH:mm"}}</div>
                                        <pre>{{selectedVersion.compose | json}}</pre>
                                        <br/>
                                        <button class="btn-link btn pull-right"
                                                ng-click="revert(selectedVersion)">Select for reversion</button>
                                    </div>

                                </div>
                            </div>



                        </uib-tab>

                    </uib-tabset>



                </div>
            </div>


        </uib-tab>
        <uib-tab ng-if="false" heading="List VS by date modified">
            <table class="table-bordered table">
                <tr ng-repeat = "item in sortedVS">
                    <td>{{item.vs.meta.lastUpdated | date : "MMM d, h:mm a y"}} </td>
                    <td>{{item.vs.meta.lastUpdated | ageSeconds}}</td>
                    <td>{{item.display}}</td>


                </tr>
            </table>

        </uib-tab>


        <uib-tab>
            <uib-tab-heading>Unpublished concepts
                <span ng-if="false" class="badge">{{prePubCS.concept.length}}
                </span>
            </uib-tab-heading>
            <br/>

            <uib-tabset>
                <uib-tab heading="List">
                    <em>This is the custom ValueSet for unpublished concepts. These are concepts that have been defined
                        in SNOMED but not yet published. They have a different system url (as they don't yet exist in the
                        Terminology Server). If they are used by an implementer, then they will be responsible for making
                        any changes required once the concepts are formally published. </em>
                    <uib-tabset>
                        <uib-tab heading="Table">
                            <br/>
                            <table class="table table-bordered">
                                <tr><th>Code</th><th>Display</th></tr>
                                <tr ng-repeat="concept in prePubCS.concept">
                                    <td>{{concept.code}}</td>
                                    <td>{{concept.display}}</td>

                                </tr>
                            </table>

                        </uib-tab>
                        <uib-tab heading="Json">
                            <pre>{{prePubCS | json}}</pre>

                        </uib-tab>
                    </uib-tabset>

                </uib-tab>
                <uib-tab heading="Audit">
                    <ng-include src="'/includes/unpublishedCodes.html'"></ng-include>
                </uib-tab>
            </uib-tabset>





        </uib-tab>



        <uib-tab heading="Non-SNOMED ValueSets">
            <div ng-controller="customCodeSystemCtrl">
                <ng-include src="'/includes/customCodeSystem.html'"></ng-include>
            </div>

        </uib-tab>
        <uib-tab heading="ConceptMap">

            <ng-include src="'/includes/cmUploader.html'"></ng-include>



        </uib-tab>

        <uib-tab heading="Batch ValueSet upload">

            <ng-include src="'/includes/batchVS.html'"></ng-include>



        </uib-tab>
        <uib-tab  heading="Test ECL">
            <br/>
            <div class="row">
                <div class="col-md-5">
                    <textarea class="form-control" rows=10 ng-model="input.testECL"></textarea>

                </div>
                <div class="col-md-2">
                    <button class="btn btn-link" ng-click="testECL(input.testECL)">Expand</button>

                </div>
                <div class="col-md-5">
                    <table class="table-bordered table">
                        <tr ng-repeat = 'concept in testECLData.expansion.contains'>
                            <td>{{concept.display}}</td>
                            <td>{{concept.code}}</td>
                            <td>{{concept.system}}</td>
                        </tr>
                    </table>


                </div>
            </div>
        </uib-tab>

        <uib-tab heading="Table">
            <br/>
            <div class="row">
                <div class="col-md-6">
                    Member count last updated: {{getMemberCountDate() | date}}

                    <button class="btn btn-link"
                            ng-hide = "showGettingMC"
                            ng-click="updateAllMemberCount()">Update member count</button>

                    <button class="btn btn-info pull-right" ng-if = "showGettingMC" style="margin-right: 8px">
                        Updating member count.  {{mcProgress}}
                    </button>


                </div>
                <div class="col-md-6">
                    <a ng-show="downloadLinkCsvName" class="btn btn-link pull-right"  download="{{downloadLinkCsvName}}"
                       href="{{downloadLinkCsv}}" title="{{downloadLinkCsvName}}" >
                        Download VS list
                    </a>
                </div>
            </div>


            <table class="table table-bordered">
                <tr><th>Id</th><th>Title</th><th>Description</th><th>Status</th><th>Count</th></tr>
                <tr
                        ng-class="{retiredVS:item.vs.status == 'retired',draftVS:item.vs.status == 'draft'}"
                        ng-repeat="item in allVSItem">
                    <td>{{item.vs.id}}</td>
                    <td>{{item.vs.title}}</td>
                    <td>{{item.vs.description}}</td>
                    <td>{{item.vs.status}}</td>
                    <td>{{getMCOneVS(item.vs.url)}}</td>
                </tr>
            </table>





        </uib-tab>

    </uib-tabset>





</div>
</body>
